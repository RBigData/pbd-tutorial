\subsection{Parallel Data Input}
\makesubcontentsslidessec


\begin{frame}
  \begin{block}{New Issues}\pause
    \begin{itemize}
    \item How to read in parallel?
    \item CSV, SQL, NetCDF4, HDF, ADIOS, custom binary
    \item How to partition data across nodes?
    \item How to structure for scalable libraries?
    \item Read directly into form needed or restructure?
    \item $\ldots$
    \item A lot of work needed here!
    \end{itemize}
  \end{block}
\end{frame}



\begin{frame}[fragile]
  \begin{exampleblock}{CSV Data}\pause
\begin{lstlisting}[title=Serial Code]
d <- read.csv("x.csv")

d
\end{lstlisting}

\begin{lstlisting}[title=Parallel Code]
library(pbdDEMO, quiet = TRUE)
init.grid()

dx <- read.csv.ddmatrix("x.csv", header=TRUE, sep=",", 
          nrows=10, ncols=10, num.rdrs=2, ICTXT=0)

dx

finalize()
\end{lstlisting}
  \end{exampleblock}
\end{frame}

\begin{frame}[fragile]
  \begin{exampleblock}{Binary Data: Vector}\pause
  Must determine who will read what portion(s) before reading
    \begin{lstlisting}
## set up start and length for reading a vector of n doubles
size <- 8 # bytes

my_ids <- get.jid(n, method="block")

my_start <- (my_ids[1] - 1)*size
my_length <- length(my_ids)

con <- file("binary.vector.file", "rb")
seekval <- seek(con, where=my_start, rw="read")
x <- readBin(con, what="double", n=my_length, size=size)
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

\begin{frame}[fragile]
  \begin{exampleblock}{Binary Data: Matrix}\pause
    \begin{lstlisting}
## read an nrow by ncol matrix of doubles split by columns
size <- 8 # bytes

my_ids <- get.jid(ncol, method="block")
my_ncol <- length(my_ids)
my_start <- (my_ids[1] - 1)*nrow*size
my_length <- my_ncol*nrow

con <- file("binary.matrix.file", "rb")
seekval <- seek(con, where=my_start, rw="read")
x <- readBin(con, what="double", n=my_length, size=size)

gdim <- c(nrow, ncol)
ldim <- c(nrow, my_ncol)
bldim <- c(nrow, allreduce(my_ncol, op="max"))
X <- new("ddmatrix", Data=matrix(x, nrow, my_ncol),
         dim=gdim, ldim=ldim, bldim=bldim, ICTXT=1)

## redistribute for ScaLAPACK's block-cyclic
X <- redistribute(X, bldim=c(2, 2), ICTXT=0)
Xprc <- prcomp(X) 
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

\begin{frame}[fragile]
  \begin{exampleblock}{NetCDF4 Data}\pause
    \begin{lstlisting}
### parallel read after determining start and length
nc <- nc_open_par(file_name)

nc_var_par_access(nc, "variable_name")
new.X <- ncvar_get(nc, "variable_name", start, length)
nc_close(nc)

finalize()
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

